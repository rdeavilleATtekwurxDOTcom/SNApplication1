<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="sys_script">
    <sys_script action="INSERT_OR_UPDATE">
        <abort_action>false</abort_action>
        <access>package_private</access>
        <action_delete>false</action_delete>
        <action_insert>true</action_insert>
        <action_query>false</action_query>
        <action_update>false</action_update>
        <active>true</active>
        <add_message>false</add_message>
        <advanced>true</advanced>
        <change_fields>false</change_fields>
        <client_callable>false</client_callable>
        <collection>x_tekso_twxapp01_cmdb_updates</collection>
        <condition/>
        <description/>
        <execute_function>false</execute_function>
        <filter_condition/>
        <is_rest>false</is_rest>
        <message/>
        <name>Debug - CMDB Updates - A I</name>
        <order>100</order>
        <priority>100</priority>
        <rest_method/>
        <rest_method_text/>
        <rest_service/>
        <rest_service_text/>
        <rest_variables/>
        <role_conditions/>
        <script><![CDATA[(function executeRule(current, previous /*null when async*/) {
	
	var debugTable = 'x_tekso_twxapp01_debug_track_data_changes';
	
	var tblName = current.getTableName();	
	var tblName2 = tblName.toString();
	
	var action = current.operation(); // insert or update or delete		
	var action2 = action.toString();

	var excludedArr = [];
	excludedArr.push('sys_id');
	excludedArr.push('sys_created_on');
	excludedArr.push('sys_created_by');
	excludedArr.push('sys_updated_on');
	excludedArr.push('sys_updated_by');
	excludedArr.push('sys_mod_count');
	//excludedArr.push('sys_meta'); //causes getED() to crash
	excludedArr.push('updated_by_script');
	excludedArr.push('inserted_by_script');	
	
	//insert --------------------------------------------------------------
	if (action2 == 'insert') {
		
		// There will be no previous values for an insert
		for (var i in current){
			if (excludedArr.indexOf(i) == -1) {
				// put in a try / catch block as some fields e.g. sys_meta cause a problem
				try {
					var ielement = current.getElement(i);					
					var idescriptor = ielement.getED();					
					var isz = idescriptor.getLength();					
					var ilbl = idescriptor.getLabel();					
					var itp = idescriptor.getInternalType();					
					var iisChoice = idescriptor.isChoiceTable();	
					var inewval = current.getElement(i);			
					var inewvalstr = '';				
					var inewln = 0;
					var iref = '';

					if (itp == 'reference') {
						iref = idescriptor.getReference();			  
					}
					if (itp == 'string' || itp == 'reference' || itp == 'integer') {
						inewvalstr = inewval.toString();
						inewln = inewvalstr.length;
					}

					if (itp == 'boolean') {
						if (inewval == true) {
							inewvalstr = 'true';
						}
						else {
							inewvalstr = 'false';
						}
					} //if (itp == 'boolean') {

					var gr1 = new GlideRecord(debugTable);
					gr1.initialize();
					gr1.setValue('action',action2);
					gr1.setValue('table_name',tblName2);
					gr1.setValue('column_name',i);
					gr1.setValue('column_label',ilbl);
					gr1.setValue('data_type',itp);
					gr1.setValue('field_size',isz);
					gr1.setValue('choice',iisChoice);
					gr1.setValue('inserted_by_script',current.inserted_by_script);					
					if (itp == 'string' || itp == 'reference' || itp == 'integer') {
						gr1.setValue('new_value_length',inewln);							
						gr1.setValue('new_value',inewvalstr);							
					}
					if (itp == 'boolean') {
						gr1.setValue('new_value',inewvalstr);					
					}
					if (itp == 'reference') {
						gr1.setValue('reference_to_table',iref);
					}
					gr1.insert();
				} // try
				catch(error) {
					//Do nothing
					var a = 1;
				}
			} // if (excludedArr.indexOf(i) == -1) {
		} // for (var i in current){					
	} //if (action2 == 'insert') {
	
	//update --------------------------------------------------------------	
	if (action2 == 'update') {		
		for (var u in current){
			if (excludedArr.indexOf(u) == -1) {
				if (current[u] != previous[u]) {	
				
					// put in a try / catch block as some fields e.g. sys_meta cause a problem
					try {
						var uelement = current.getElement(u);
						var udescriptor = uelement.getED();
						var usz = udescriptor.getLength();
						var ulbl = udescriptor.getLabel();
						var utp = udescriptor.getInternalType();
						var uisChoice = udescriptor.isChoiceTable();
						var uoldval = previous.getElement(u) || '';
						var uoldvalstr = '';
						var uoldln = 0;
						var unewval = current.getElement(u) || '';				
						var unewvalstr = '';				
						var unewln = 0;

						var uref = '';
						if (utp == 'reference') {
							uref = udescriptor.getReference();			  
						}

						if (utp == 'string' || utp == 'reference' || utp == 'integer') {
							uoldvalstr = uoldval.toString();
							unewvalstr = unewval.toString();
							uoldln = uoldvalstr.length;
							unewln = unewvalstr.length;
						}

						if (utp == 'boolean') {
							if (uoldval == true) {
								uoldvalstr = 'true';
							}
							else {
								uoldvalstr = 'false';
							}

							if (unewval == true) {
								unewvalstr = 'true';
							}
							else {
								unewvalstr = 'false';
							}
						} //if (utp == 'boolean') {

						var gr2 = new GlideRecord(debugTable);
						gr2.initialize();
						gr2.setValue('action',action2);
						gr2.setValue('table_name',tblName2);
						gr2.setValue('column_name',u);
						gr2.setValue('column_label',ulbl);
						gr2.setValue('data_type',utp);
						gr2.setValue('field_size',usz);
						gr2.setValue('choice',uisChoice);
						gr2.setValue('updated_by_script',current.updated_by_script);	
						if (utp == 'string' || utp == 'reference' || utp == 'integer') {
							gr2.setValue('old_value_length',uoldln);
							gr2.setValue('new_value_length',unewln);							
							gr2.setValue('old_value',uoldvalstr);
							gr2.setValue('new_value',unewvalstr);							
						}
						if (utp == 'boolean') {
							gr2.setValue('old_value',uoldvalstr);
							gr2.setValue('new_value',unewvalstr);					
						}
						if (utp == 'reference') {
							gr2.setValue('reference_to_table',uref);
						}
						gr2.insert();
					} // try
					catch(error) {
						//Do nothing
						var b = 1;						
					}
				} // if (current[u] != previous[u]) {
			} //if (excludedArr.indexOf(u) == -1) {
		} //for (var x in current){
	} //if (action2 == 'update') {
	
})(current, previous);]]></script>
        <sys_class_name>sys_script</sys_class_name>
        <sys_created_by>robin</sys_created_by>
        <sys_created_on>2020-06-03 14:35:29</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>4cbce7e7db49149041d08f3813961912</sys_id>
        <sys_mod_count>13</sys_mod_count>
        <sys_name>Debug - CMDB Updates - A I</sys_name>
        <sys_overrides/>
        <sys_package display_value="Application 1" source="x_tekso_twxapp01">993be4b2db62085035a38a72399619a7</sys_package>
        <sys_policy/>
        <sys_scope display_value="Application 1">993be4b2db62085035a38a72399619a7</sys_scope>
        <sys_update_name>sys_script_4cbce7e7db49149041d08f3813961912</sys_update_name>
        <sys_updated_by>robin</sys_updated_by>
        <sys_updated_on>2020-06-04 15:13:39</sys_updated_on>
        <template/>
        <when>after</when>
    </sys_script>
    <sys_translated_text action="delete_multiple" query="documentkey=4cbce7e7db49149041d08f3813961912"/>
</record_update>
