<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="sysevent_script_action">
    <sysevent_script_action action="INSERT_OR_UPDATE">
        <active>true</active>
        <condition_script/>
        <description/>
        <event_name>x_tekso_twxapp01.senddatatoucontrol</event_name>
        <name>SendDataTouControl</name>
        <order>100</order>
        <script><![CDATA[//gs.eventQueue('x_tekso_twxapp01.senddatatoucontrol', gr1, jobSysID2, calculatedNextJobStartTime);
//gr1 = x_tekso_twxapp01_scheduled_job_log record

SendDataToUControl();

function SendDataToUControl() {
	//Note: parm not param
	//gs DOT info('event.parm1: ' + event.parm1); // gs.getUserID()
	//gs DOT info('event.parm2: ' + event.parm2); 

	var script = 'SA SendDataTouControl';
	//This message will be output if property x_tekso_twxapp01.debug is 2 or higher	
	new x_tekso_twxapp01.DebugLogging().message(script,2,'SA SendDataTouControl - Started');
	
	var jobTable = 'x_tekso_twxapp01_scheduled_job_log';
	var setupTable = 'x_tekso_twxapp01_setup';

	var scriptStartTime = new GlideDateTime();	
	var jobSysID = event.parm1; //current.sys_id;
	var nextRunAt = event.parm2; // The date/time the scheduled job is going to run next

	var gr1 = new GlideRecordSecure(jobTable); //x_tekso_twxapp01_scheduled_job_log
	gr1.addQuery('sys_id',jobSysID);
	gr1.query();
	if (gr1.next()) {
		// Got the x_tekso_twxapp01_scheduled_job_log record		
		var jobStartTime = gr1.getValue('sys_created_on');
		gr1.setValue('background_job_started_at',scriptStartTime);
		gr1.setValue('updated_by_script','SA SendDataTouControl');
		gr1.update();
		
		var setupStatus = '';
		var gr2 = new GlideRecordSecure(setupTable); //x_tekso_twxapp01_setup
		gr2.query();
		if (gr2.next()) {
			// Got the x_tekso_twxapp01_setup record
			setupStatus = gr2.getValue('status') || ''; //Needed Now

			var setupPollingInterval = gr2.getValue('ucontrol_polling_interval_minutes') || 0; 
			var setupConnTimeout = gr2.getValue('ucontrol_connection_timeout_minutes') || 0; 
			var setupURL = gr2.getValue('ucontrol_url') || ''; 

			// Need to use getElement to do dot walking.
			var setupMIDServerSysID = gr2.getElement('ucontrol_mid_server.sys_id') || '';
			var setupMIDServerSysID2 = setupMIDServerSysID.toString(); 

			var setupMIDServerName = gr2.getElement('ucontrol_mid_server.name') || '';	
			var setupMIDServerName2 = setupMIDServerName.toString();

			var setupIntegrationUserSysID = gr2.getElement('ucontrol_integration_user.sys_id') || '';
			var setupIntegrationUserSysID2 = setupIntegrationUserSysID.toString();

			var setupIntegrationUserName = gr2.getElement('ucontrol_integration_user.name') || '';
			var setupIntegrationUserName2 = setupIntegrationUserName.toString(); 

			var setupMaxRetries = gr2.getValue('max_retries') || 0;
			
			gr2.setValue('last_scan_performed_at',jobStartTime);	
			gr2.setValue('updated_by_script','SA SendDataTouControl'); // Debug
			gr2.update();	
			
			gr1.setValue('max_retries',setupMaxRetries);
			gr1.setValue('ucontrol_connection_timeout_minutes',setupConnTimeout);
			gr1.setValue('ucontrol_integration_user_name',setupIntegrationUserName2);
			gr1.setValue('ucontrol_integration_user_sys_id',setupIntegrationUserSysID2);
			gr1.setValue('ucontrol_mid_server_name',setupMIDServerName2);
			gr1.setValue('ucontrol_mid_server_sys_id',setupMIDServerSysID2);
			gr1.setValue('ucontrol_polling_interval_minutes',setupPollingInterval);
			gr1.setValue('ucontrol_url',setupURL);
			gr1.setValue('setup_status',setupStatus);
			
			gr1.setValue('updated_by_script','SA SendDataTouControl');
			gr1.update();		
		} // if (gr2.next()) {
		
		var noOfPendingRecs = getNumberOfPendingRecords(jobStartTime);		
		if (noOfPendingRecs > 0) {
			gr1.setValue('records_selected',true);
			gr1.setValue('updated_by_script','SA SendDataTouControl'); // Debug
			gr1.update();
			
			if (setupStatus == 'Sending') {
				//There are records to process and the status is Sending
				process(jobStartTime,nextRunAt,jobSysID);
			}
		} // if (noOfPendingRecs > 0) {
				
		//This updates the Stats
		updateScheduledJobLogStats(jobSysID);
		
		var scriptEndTime = new GlideDateTime();	
		gr1.setValue('background_job_finished_at',scriptEndTime);
		gr1.setValue('updated_by_script','SA SendDataTouControl'); // Debug
		gr1.update();
	} // if (gr1.next()) {
	
	//This message will be output if property x_tekso_twxapp01.debug is 2 or higher	
	new x_tekso_twxapp01.DebugLogging().message(script,2,'SA SendDataTouControl - Finished');	
}	

function updateScheduledJobLogStats(jobSysID) {

	var jobTable = 'x_tekso_twxapp01_scheduled_job_log';
	var logTable = 'x_tekso_twxapp01_processing_log';
	var setupTable = 'x_tekso_twxapp01_setup';
	
	var gr1 = new GlideRecordSecure(jobTable);
	gr1.addQuery('sys_id',jobSysID);
	gr1.query();
	if (gr1.next()) {

		var noOfRecordsSent = numberOfRecordsLinkedToJob(jobSysID);
		var noOfUpdatesSent = numberOfUpdatesLinkedToJob(jobSysID);
		var noOfDeletesSent = numberOfDeletesLinkedToJob(jobSysID);	
		// Builds a string like this: 3 records (3 updates , 0 deletes)		
		var dataSentSummary = sendSummary(noOfRecordsSent,noOfUpdatesSent,noOfDeletesSent);
		
		if (noOfUpdatesSent > 0 || noOfDeletesSent > 0) {
			//Only proceed if there was something to process
			var updatesPerClass = getUpdatesPerClassLinkedToJob(jobSysID);
			var deletesPerClass = getDeletesPerClassLinkedToJob(jobSysID);

			var gr2 = new GlideRecordSecure(logTable); //x_tekso_twxapp01_processing_log
			gr2.addQuery('link_to_scheduled_job_log_record',jobSysID);
			gr2.orderBy('number');
			gr2.query();
			var first = '';
			var last = '';
			var cnt = 0;
			var summary = '';
			while(gr2.next()) {
				var number = gr2.getValue('number');
				var totalQty = gr2.getValue('total_number_of_records_sent') || 0;
				var totalQty2 = totalQty.toString();
				var record = number + ' Qty: ' + totalQty2;
				if (cnt == 0) {
					summary = record;
					first = gr2.getValue('sys_id');
				}
				else {
					summary = summary + '; ' + record;
				}
				last = gr2.getValue('sys_id');
				cnt = cnt + 1;
			}			
			gr1.setValue('link_to_first_processing_log_record',first);
			gr1.setValue('first_processing_log_record_sys_id',first);
			gr1.setValue('link_to_last_processing_log_record',last);
			gr1.setValue('last_processing_log_record_sys_id',last);
			gr1.setValue('number_of_processing_log_records',cnt);
			gr1.setValue('processing_log_contents_summary',summary);
			gr1.setValue('records_sent',true);
			gr1.setValue('data_sent_deletes_per_class',deletesPerClass);
			gr1.setValue('data_sent_updates_per_class',updatesPerClass);	
		} // if (noOfUpdatesSent > 0 || noOfDeletesSent > 0) 

		gr1.setValue('total_number_of_records_sent',noOfRecordsSent);
		gr1.setValue('number_of_deletes_sent',noOfDeletesSent);
		gr1.setValue('number_of_updates_sent',noOfUpdatesSent);
		gr1.setValue('data_sent_summary',dataSentSummary);		
		gr1.setValue('updated_by_script','SA SendDataTouControl'); // Debug		
		gr1.update();
		
		// Only update setup if there was some data in this scheduled job log
		if (noOfDeletesSent > 0 || noOfUpdatesSent > 0) {
			var gr3 = new GlideRecordSecure(setupTable); //x_tekso_twxapp01_setup
			gr3.query();
			if (gr3.next()) {
				gr3.setValue('link_to_last_scheduled_job_log_record',jobSysID);		
				gr3.setValue('last_scheduled_job_data_sent_summary',dataSentSummary);		
				gr3.setValue('updated_by_script','SA SendDataTouControl'); // Debug		
				gr3.update();
			} //if (gr3.next()) {
		} //if (noOfDeletesSent > 0 || noOfUpdatesSent > 0) {
	} //if (gr1.next()) {
}

function getNumberOfPendingRecords(jobStartTime) {
	// Get the number of pending records with a cut off at the job start time
	var trackingTable = 'x_tekso_twxapp01_cmdb_changes';
	var rtnCnt = 0;
	var gr1 = new GlideAggregate(trackingTable); //x_tekso_twxapp01_cmdb_changes
	gr1.addQuery('status','Pending');
	gr1.addQuery('processing_id','');	
	gr1.addQuery('sys_created_on','<',jobStartTime); 
	gr1.addAggregate('COUNT');
	gr1.query();
	gr1.next(); // GlideAggregate needs the .next()
	rtnCnt = gr1.getAggregate('COUNT');	
	return rtnCnt;
}



function process(jobStartTime,nextRunAt,jobSysID) {
	
	var trackingTable = 'x_tekso_twxapp01_cmdb_changes';
	var jobTable = 'x_tekso_twxapp01_scheduled_job_log';
	var totRecCnt = 0;
	var repeat = false;
	var loopCnt = 0;
	
	var arrRecCnt = []; //Integer
	var arrProcessingID = []; //Sys ID
	var arrUniqueData = []; //T/F
	var arrTestData = []; //T/F
	
	// do while loop - go through at least once
	do {
		//First time through this will be set to 1
		loopCnt = loopCnt + 1;
		
		//Set to false again
		repeat = false;
		
		// Get all the records that are Pending
		var pID = gs.generateGUID();
		var sysIDArr = [];
		var sysIDsInBlockAreUnique = true;
		var dataToProcess = false;

		var recCnt = 0;

		var tstData = isFirstPendingRecordATestRecord(jobStartTime);
		
		// Don't want to mix live data and test data together
		// Get the first record back - and see if it is test or live
		var gr1 = new GlideRecordSecure(trackingTable); //x_tekso_twxapp01_cmdb_changes
		gr1.addQuery('status','Pending');
		gr1.addQuery('processing_id','');		
		gr1.addQuery('test_data',tstData); 

		//This should only get the records that were created
		//before the schedule job started - this should stop the system from chasing its tail	
		gr1.addQuery('sys_created_on','<',jobStartTime); 	
		//Order by created on
		gr1.orderBy('sys_created_on'); // For descending use - gr2.orderByDesc("sys_created_on");
		
		//Limit to 2000
		gr1.setLimit(2000);
		gr1.query();		

		while(gr1.next()) {
			// Read the sys_id's and check if they are all unique
			var sysID = gr1.getValue('sys_id');
			if (sysIDArr.indexOf(sysID) == -1) {
				//sysID is not already in the array sysIDArr
				sysIDArr.push(sysID);
			}
			else {
				sysIDsInBlockAreUnique = false;
			}
			gr1.setValue('status','Processing');
			gr1.setValue('processing_id',pID); // Processing ID GUID. Used to ensure we pick up the correct block of data		
			gr1.setValue('updated_by_script','SA SendDataTouControl'); // Debug
			gr1.update();
			dataToProcess = true;
			recCnt = recCnt + 1;
			
		} //while(gr1.next()) {
		totRecCnt = totRecCnt + recCnt;
		
		arrRecCnt.push(recCnt); //Integer
		arrProcessingID.push(pID);//Sys ID
		arrUniqueData.push(sysIDsInBlockAreUnique); //T/F
		arrTestData.push(tstData); //T/F
		

		
		// Get another 2000?
		var secsLeft = secondsRemainingBeforeNextRunOfScheduledJob(nextRunAt);
		//Subtract 10 more seconds as a precaution
		secsLeft = secsLeft - 10;
		
		//Are there any more pending records?
		var noOfPendingRecs = getNumberOfPendingRecords(jobStartTime);
			
		// If there are more records to process and the next scheduled job has not yet started
		// and we got back some data in the last loop
		if (noOfPendingRecs > 0 && secsLeft > 0 && dataToProcess == true) {
			repeat = true;
		}
		else {
			repeat = false;
		}
	} 
	// loopCnt < 1000 is a safety
	while (repeat == true && loopCnt < 1000);
	
	var gr3 = new GlideRecordSecure(jobTable);
	gr3.addQuery('sys_id',jobSysID);
	gr3.query();
	if (gr3.next()) {	
		gr3.setValue('total_number_of_records_selected',totRecCnt);
		var now = new GlideDateTime();
		gr3.setValue('records_selected_at',now);
		gr3.setValue('updated_by_script','SA SendDataTouControl'); // Debug		
		gr3.update();
	}
	
	if (totRecCnt > 0) {
		var cnt = 1;
		for (var i = 0; i < arrProcessingID.length; i++) {
			var pID2 = arrProcessingID[i];
			var sysIDsInBlockAreUnique2 = arrUniqueData[i];
			processBlock(pID2,sysIDsInBlockAreUnique2,jobSysID,cnt);
			cnt = cnt + 1;
		}
	}
}

function secondsRemainingBeforeNextRunOfScheduledJob(nextRunAt) {
	var secsLeft = 0;
	var now = new GlideDateTime();	
	var nextRunAt2 = new GlideDateTime(nextRunAt);
	var dur = new GlideDuration();
	dur = GlideDateTime.subtract(now,nextRunAt2);// In Milliseconds
	secsLeft = parseInt(dur.getNumericValue() / 1000); 	
	return secsLeft;
}

function isFirstPendingRecordATestRecord(jobStartTime) {
	var rtn = false;
	var trackingTable = 'x_tekso_twxapp01_cmdb_changes';
	var gr1 = new GlideRecordSecure(trackingTable); //x_tekso_twxapp01_cmdb_changes
	gr1.addQuery('status','Pending');
	gr1.addQuery('processing_id','');

	//This should only get the records that were created
	//before the schedule job started - this should stop the system from chasing its tail
	gr1.addQuery('sys_created_on','<',jobStartTime); 
	//Order by created on
	gr1.orderBy('sys_created_on'); // For descending use - gr2.orderByDesc("sys_created_on");
	gr1.setLimit(1);
	gr1.query();
	if (gr1.next()) {
		// Get 1 record
		// Is it test data or real data?
		rtn = gr1.getValue('test_data') || false;	
	}
	return rtn;
}


function processBlock(pID,sysIDsInBlockAreUnique,jobSysID,processCnt) { 
	
	//Remove the XX's to use	
	//writeXXDebugXXLog('mainBit Start');
	
	var trackingTable = 'x_tekso_twxapp01_cmdb_changes';
	var recCnt = 0;
	var trackingSysID = '';
	var action = '';
	var bsTbl = '';
	var table = '';
	var tstData = false;
	var midSrvNm = '';
	var midSrvSysID = '';
	var user = '';
	var url ='';
	var srcRecSysID = '';
	var dt = new GlideDateTime();
	var jsonRequestBody = '';
	var prevAction = '';
	var prevBaseTable = '';
	var prevTestData = false;
	var prevMIDServerName = '';
	var prevMIDServerSysID = '';
	var prevURL = '';
	var prevUser = '';

	var deletesToProcess = 0;
	var deleteDataList = '';
	var deleteMetaData = '';
	var delete_data_sys_id = '';
	var deleteJsonRequestBody = '';
	
	var deleteDataListSize = 0;
	var deleteMetaDataSize = 0;
	var deleteJsonRequestBodySize = 0;
	var deleteDataToFlushOut = false;
	
	var updatesToProcess = 0;
	var updateDataList = '';
	var updateMetaData = '';
	var update_data_sys_id = '';
	var updateJsonRequestBody = '';

	var updateDataListSize = 0;
	var updateMetaDataSize = 0;
	var updateJsonRequestBodySize = 0;
	var updateDataToFlushOut = false;
	
	var insertData = '';
	var insertJsonRequestBody = '';
	
	var data_sys_id = '';	
	var dataRecordNo = '';
	var metaData = '';

	var logRecordCreated = false;
	var logSysID = '';
	var testSize = 0;
	
	var brkRsn = 'First';
	
	var gr2 = new GlideRecordSecure(trackingTable); //x_tekso_twxapp01_cmdb_changes
	gr2.addQuery('status','Processing');
	gr2.addQuery('processing_id',pID); // Processing ID GUID. Used to ensure we pick up the correct block of data
	//as if there are jobs running concurrently then status = Processing may pick up the wrong records
	if (sysIDsInBlockAreUnique == true) {
		//If all the sysIDs in the block are unique then we can change their order
		//Which should make things more efficient
		gr2.orderBy('action');     
		gr2.orderBy('base_table');
		gr2.orderBy('table');		
	}
	gr2.orderBy('sys_created_on'); // For descending use - gr2.orderByDesc("sys_created_on");
	gr2.query();
	while(gr2.next()) {	
		recCnt++;
		trackingSysID = gr2.getValue('sys_id');
		srcRecSysID = gr2.getValue('source_record_sys_id') || '';	
		action = gr2.getValue('action') ||'';
		bsTbl = gr2.getValue('base_table') || '';
		table = gr2.getValue('table') || '';	
		// If this is true then we are sending testData
		tstData = gr2.getValue('test_data') || false;
		
		midSrvNm = gr2.getValue('ucontrol_mid_server_name') || '';
		midSrvSysID = gr2.getValue('ucontrol_mid_server_sys_id') || '';	
		url = gr2.getValue('ucontrol_url') || '';
		user = gr2.getValue('sys_created_by') || '';	
		dt = gr2.getValue('sys_created_on') || '';
		jsonRequestBody = gr2.getValue('json_request_body') || '';
		metaData = gr2.getValue('metadata') || '';

		// Is there any delete or update data that needs to be pushed out first?
		if (recCnt > 1) {

			if (deletesToProcess > 0) {
				updatesToProcess = 0;
				updateDataList = '';
				
				updateDataListSize = 0;
				updateMetaDataSize = 0;
				updateJsonRequestBodySize = 0;
				updateDataToFlushOut = false;
				
				//If we add on the length of the latest jsonRequestBody to the existing - how big is it?
				testSize = deleteJsonRequestBodySize + jsonRequestBody.length;
				
				// Action is not delete or change in baseTable / midServer / url / testData
				// Don't put data and testData in the same block
				if (action != 'delete') {
					// Delete data to be flushed out
					deleteDataToFlushOut = true;		
					brkRsn = 'action NOT delete. New action is: ' + action;					
				}				

				if (deleteDataToFlushOut == false && bsTbl != prevBaseTable) {
					// Delete data to be flushed out
					deleteDataToFlushOut = true;		
					brkRsn = 'baseTable NOT prevBaseTable. baseTable: ' + bsTbl + ' prevBaseTable: ' + prevBaseTable;
				}		

				if (deleteDataToFlushOut == false && midSrvNm != prevMIDServerName) {
					// Delete data to be flushed out
					deleteDataToFlushOut = true;		
					brkRsn = 'midServerName NOT prevMIDServerName. midServerName: ' + midSrvNm + ' prevMIDServerName: ' + prevMIDServerName;
				}	

				if (deleteDataToFlushOut == false && url != prevURL) {
					// Delete data to be flushed out
					deleteDataToFlushOut = true;		
					brkRsn = 'url NOT prevURL. url: ' + url + ' prevURL: ' + prevURL;
				}	

				if (deleteDataToFlushOut == false && tstData != prevTestData) {
					// Delete data to be flushed out
					deleteDataToFlushOut = true;		
					brkRsn = 'testData NOT prevTestData. testData: ' + tstData + ' prevTestData: ' + prevTestData;
				}

				if (deleteDataToFlushOut == false && deletesToProcess >= 1000) {
					// Delete data to be flushed out
					deleteDataToFlushOut = true;		
					brkRsn = 'deletesToProcess >= 1000';
				}
							
				//5,000,000 is max size of json field
				if (deleteDataToFlushOut == false && action == 'delete' && testSize >= 5000000) {
					// Need to check if there is enough room to add in another delete
					// Or do we need to flush this out and then start a new one?
					deleteDataToFlushOut = true;
					brkRsn = '5,000,000 is max size of json field';
				}
				
				if (deleteDataToFlushOut == true) {
					// PROCESS deleteData			
					deleteDataList = '\"deletedData\": [' + deleteDataList + ']';
					deleteJsonRequestBody = '{' + deleteMetaData + ',' + deleteDataList + '}';
					
					addJSONToDataRecord(delete_data_sys_id,deleteJsonRequestBody,deletesToProcess);
					
					gs.eventQueue('x_tekso_twxapp01.outboundrestprocess', gr2, gs.getUserID(),delete_data_sys_id);
					
					deletesToProcess = 0;
					deleteDataList = '';
					deleteDataListSize = 0;
					deleteMetaDataSize = 0;
					deleteJsonRequestBodySize = 0;
					deleteDataToFlushOut = false;
					
				} // deletes to flush out
			} // if deletesToProcess > 0	
			
			if (updatesToProcess > 0) {
				deletesToProcess = 0;
				deleteDataList = '';

				deleteDataListSize = 0;
				deleteMetaDataSize = 0;
				deleteJsonRequestBodySize = 0;
				deleteDataToFlushOut = false;
				
				//If we add on the length of the latest jsonRequestBody to the existing - how big is it?
				testSize = updateJsonRequestBodySize + jsonRequestBody.length;
				
				// Action is not update or change in baseTable / midServer / url
				// Don't put data and testData in the same block		
				if (action != 'update') {
					// Update data to be flushed out
					updateDataToFlushOut = true;	
					brkRsn = 'action NOT delete. New action is: ' + action;					
				}				

				if (updateDataToFlushOut == false && bsTbl != prevBaseTable) {
					// Update data to be flushed out
					updateDataToFlushOut = true;		
					brkRsn = 'baseTable NOT prevBaseTable. baseTable: ' + bsTbl + ' prevBaseTable: ' + prevBaseTable;
				}		

				if (updateDataToFlushOut == false && midSrvNm != prevMIDServerName) {
					// Update data to be flushed out
					updateDataToFlushOut = true;	
					brkRsn = 'midServerName NOT prevMIDServerName. midServerName: ' + midSrvNm + ' prevMIDServerName: ' + prevMIDServerName;
				}	

				if (updateDataToFlushOut == false && url != prevURL) {
					// Update data to be flushed out
					updateDataToFlushOut = true;	
					brkRsn = 'url NOT prevURL. url: ' + url + ' prevURL: ' + prevURL;
				}	

				if (updateDataToFlushOut == false && tstData != prevTestData) {
					// Update data to be flushed out
					updateDataToFlushOut = true;	
					brkRsn = 'testData NOT prevTestData. testData: ' + tstData + ' prevTestData: ' + prevTestData;
				}

				if (updateDataToFlushOut == false && updatesToProcess >= 1000) {
					// Update data to be flushed out
					updateDataToFlushOut = true;	
					brkRsn = 'updatesToProcess >= 1000';
				}
							
				//5,000,000 is max size of json field
				if (updateDataToFlushOut == false && action == 'update' && testSize >= 5000000) {
					// Need to check if there is enough room to add in another update
					// Or do we need to flush this out and then start a new one?
					updateDataToFlushOut = true;
					brkRsn = '5,000,000 is max size of json field';
				}
				
				if (updateDataToFlushOut == true) {					
					// PROCESS updateData			
					updateDataList = '\"updateData\": [' + updateDataList + ']';				
					updateJsonRequestBody = '{' + updateMetaData + ',' + updateDataList + '}';
						
					addJSONToDataRecord(update_data_sys_id,updateJsonRequestBody,updatesToProcess);
					
					gs.eventQueue('x_tekso_twxapp01.outboundrestprocess', gr2, gs.getUserID(),update_data_sys_id);
					
					updatesToProcess = 0;
					updateDataList = '';
					updateDataListSize = 0;
					updateMetaDataSize = 0;
					updateJsonRequestBodySize = 0;
					updateDataToFlushOut = false;
							
				} // updates to flush out
			} // if updatesToProcess > 0
			
		} // if recCnt > 1

		// Normal insert
		if (action == 'insert') {
			deletesToProcess = 0;
			deleteDataList = '';
			updatesToProcess = 0;
			updateDataList = '';
			
			updateDataListSize = 0;
			updateMetaDataSize = 0;
			updateJsonRequestBodySize = 0;
			updateDataToFlushOut = false;

			deleteDataListSize = 0;
			deleteMetaDataSize = 0;
			deleteJsonRequestBodySize = 0;
			deleteDataToFlushOut = false;
			
			if (logRecordCreated == false) {
				// If not already done so - Create a new log record - x_tekso_twxapp01_processing_log and get back the sys_id
				//x_tekso_twxapp01_processing_log
				logSysID = createNewLogRecord(jobSysID,processCnt,pID); 

				logRecordCreated = true;
				//logSysID is the sys_id for the log record
			}
			
			// 1 Record
			/* use createDataRecordWithEmptyJSON so we can get back the sys_id to include in the json
			data_sys_id = createDataRecordWithJSON(dataTable,action,bsTbl,tstData,midSrvNm,midSrvSysID,url,insertJsonRequestBody,1,logSysID);
			*/
			data_sys_id = createDataRecordWithEmptyJSON(brkRsn,action,bsTbl,tstData,midSrvNm,midSrvSysID,url,logSysID,jobSysID,pID);
			dataRecordNo = getDataRecordNo(data_sys_id);			
			
			insertData = '\"insertedData\": ' + jsonRequestBody;
			metaData = metaData + ',\"data_sys_id\":\"' + data_sys_id + '\"';
			metaData = metaData + ',\"data_record_no\":\"' + dataRecordNo + '\"';	
			
			//Flag if test data
			if (tstData == true) {
				metaData = metaData + ',\"test_data\":\"true\"';	
			}
			insertJsonRequestBody = '{' + metaData + ',' + insertData + '}';

			addJSONToDataRecord(data_sys_id,insertJsonRequestBody,1);			
			createLinkRecord(action,table,bsTbl,tstData,srcRecSysID,data_sys_id,trackingSysID,logSysID,jobSysID,pID);
			
			gs.eventQueue('x_tekso_twxapp01.outboundrestprocess', gr2, gs.getUserID(),data_sys_id);
		}

		// If delete then store it up and process later
		if (action == 'delete') {
			updatesToProcess = 0;
			updateDataList = '';
			
			updateDataListSize = 0;
			updateMetaDataSize = 0;
			updateJsonRequestBodySize = 0;
			updateDataToFlushOut = false;
			
			// Store up the delete record
			if (deletesToProcess == 0) {
				// First one
				deleteDataListSize = 0;
				deleteMetaDataSize = 0;
				deleteJsonRequestBodySize = 0;
				
				if (logRecordCreated == false) {
					// If not already done so - Create a new log record - x_tekso_twxapp01_processing_log and get back the sys_id
					//x_tekso_twxapp01_processing_log
					logSysID = createNewLogRecord(jobSysID,processCnt,pID); 

					logRecordCreated = true;
					//logSysID is the sys_id for the log record
				}	
				
				delete_data_sys_id = createDataRecordWithEmptyJSON(brkRsn,action,bsTbl,tstData,midSrvNm,midSrvSysID,url,logSysID,jobSysID,pID);
				dataRecordNo = getDataRecordNo(delete_data_sys_id);
				
				createLinkRecord(action,table,bsTbl,tstData,srcRecSysID,delete_data_sys_id,trackingSysID,logSysID,jobSysID,pID);		
				deleteDataList = '';
				deleteMetaData = metaData + ',\"data_sys_id\":\"' + delete_data_sys_id + '\"';
				deleteMetaData = deleteMetaData + ',\"data_record_no\":\"' + dataRecordNo + '\"';
				
				//Flag if test data
				if (tstData == true) {
					deleteMetaData = deleteMetaData + ',\"test_data\":\"true\"';	
				}								
			}
			else {
				// Not the first one
				deleteDataList = deleteDataList + ',';

				if (logRecordCreated == false) {
					// If not already done so - Create a new log record - x_tekso_twxapp01_processing_log and get back the sys_id
					//x_tekso_twxapp01_processing_log
					logSysID = createNewLogRecord(jobSysID,processCnt,pID); 					

					logRecordCreated = true;
					//logSysID is the sys_id for the log record
				}					
				createLinkRecord(action,table,bsTbl,tstData,srcRecSysID,delete_data_sys_id,trackingSysID,logSysID,jobSysID,pID);			
			}		
			deleteDataList = deleteDataList + jsonRequestBody;
			
			deleteDataListSize = deleteDataList.length;
			deleteMetaDataSize = deleteMetaData.length;
			deleteJsonRequestBodySize = deleteDataListSize + deleteMetaDataSize + 3; // { metaData , data }
			
			deletesToProcess++;					
		} // if (action == 'delete')
		
		// If update then store it up and process later
		if (action == 'update') {
			deletesToProcess = 0;
			deleteDataList = '';
			deleteDataListSize = 0;
			deleteMetaDataSize = 0;
			deleteJsonRequestBodySize = 0;
			deleteDataToFlushOut = false;
			
			// Store up the update record
			if (updatesToProcess == 0) {
				// First one
				updateDataListSize = 0;
				updateMetaDataSize = 0;
				updateJsonRequestBodySize = 0;
				
				if (logRecordCreated == false) {
					// If not already done so - Create a new log record - x_tekso_twxapp01_processing_log and get back the sys_id
					//x_tekso_twxapp01_processing_log
					logSysID = createNewLogRecord(jobSysID,processCnt,pID); 				

					logRecordCreated = true;
					//logSysID is the sys_id for the log record
				}					
				update_data_sys_id = createDataRecordWithEmptyJSON(brkRsn,action,bsTbl,tstData,midSrvNm,midSrvSysID,url,logSysID,jobSysID,pID);
				dataRecordNo = getDataRecordNo(update_data_sys_id);
				
				createLinkRecord(action,table,bsTbl,tstData,srcRecSysID,update_data_sys_id,trackingSysID,logSysID,jobSysID,pID);		
				updateDataList = '';
				updateMetaData = metaData + ',\"data_sys_id\":\"' + update_data_sys_id + '\"';
				updateMetaData = updateMetaData + ',\"data_record_no\":\"' + dataRecordNo + '\"';	
				
				//Flag if test data
				if (tstData == true) {
					updateMetaData  = updateMetaData  + ',\"test_data\":\"true\"';	
				}				
			}
			else {
				// Not the first one
				updateDataList = updateDataList + ',';

				if (logRecordCreated == false) {
					// If not already done so - Create a new log record - x_tekso_twxapp01_processing_log and get back the sys_id
					//x_tekso_twxapp01_processing_log
					logSysID = createNewLogRecord(jobSysID,processCnt,pID); 

					logRecordCreated = true;
					//logSysID is the sys_id for the log record
				}							
				createLinkRecord(action,table,bsTbl,tstData,srcRecSysID,update_data_sys_id,trackingSysID,logSysID,jobSysID,pID);			
			}		
			updateDataList = updateDataList + jsonRequestBody;
			
			updateDataListSize = updateDataList.length;
			updateMetaDataSize = updateMetaData.length;
			updateJsonRequestBodySize = updateDataListSize + updateMetaDataSize + 3; // { metaData , data }
			
			updatesToProcess++;					
		} // if (action == 'delete')
		
		prevAction = action;
		prevBaseTable = bsTbl;
		prevMIDServerName = midSrvNm;
		prevMIDServerSysID = midSrvSysID;
		prevURL = url;
		prevUser = user;
		prevTestData = tstData;
		
	} // while(gr2.next()) 

	// Gone through all the records
	// There may be deletes or updates banked up that need to be output
	if (deletesToProcess > 0) {
		// There are some deletes left to process
		deleteDataList = '\"deletedData\": [' + deleteDataList + ']';	
		jsonRequestBody = '{' + deleteMetaData + ',' + deleteDataList + '}';
		
		addJSONToDataRecord(delete_data_sys_id,jsonRequestBody,deletesToProcess);

		gs.eventQueue('x_tekso_twxapp01.outboundrestprocess', gr2, gs.getUserID(),delete_data_sys_id);
		
	} // if (deletesToProcess > 0) 

	if (updatesToProcess > 0) {
		// There are some updates left to process
		updateDataList = '\"updatedData\": [' + updateDataList + ']';	
		jsonRequestBody = '{' + updateMetaData + ',' + updateDataList + '}';
				
		addJSONToDataRecord(update_data_sys_id,jsonRequestBody,updatesToProcess);
				
		gs.eventQueue('x_tekso_twxapp01.outboundrestprocess', gr2, gs.getUserID(),update_data_sys_id);
	} // if (updatesToProcess > 0)
	
	// processing_completed_at
	if (logRecordCreated == true) {
		updateProcessingLogStats(logSysID);
	}
	
	//Remove the XX's to use	
	//writeXXDebugXXLog('mainBit End');
}


function writeDebugLog(msg) {
	var debugTable = 'x_tekso_twxapp01_debug_log';
	var gr1 = new GlideRecordSecure(debugTable);
	gr1.initialize();
	gr1.setValue('message',msg);
	gr1.setValue('inserted_by_script','SA SendDataTouControl');	
	gr1.insert();
}

// Called by processBlock
function createNewLogRecord(jobSysID,processCnt,pID) {
	// Create a new log record - x_tekso_twxapp01_processing_log and returns the sys_id
	var logTable = 'x_tekso_twxapp01_processing_log';
	var jobTable = 'x_tekso_twxapp01_scheduled_job_log';
	
	var pollingInterval = 0;
	var timeout = 0;
	var url = '';
	var midSrvSysID = '';
	var midSrvSysID2 = '';
	var midSrvNm = '';
	var midSrvNm2 = '';	
	var integrationUserSysID = '';
	var integrationUserSysID2 = '';	
	var integrationUserName = '';
	var integrationUserName2 = '';	
	var maxRetries = 0;
	var jobStartedAt = new GlideDateTime();
	var noOfLogRecords = 0; 
	var gotJobRecord = false;
	
	var gr1 = new GlideRecordSecure(jobTable); //x_tekso_twxapp01_scheduled_job_log
	gr1.addQuery('sys_id',jobSysID);
	gr1.query();
	if (gr1.next()) {	
		gotJobRecord = true;
		timeout = gr1.getValue('ucontrol_connection_timeout_minutes') || 0;
		integrationUserName = gr1.getValue('ucontrol_integration_user_name') || '';
		integrationUserName2 = integrationUserName.toString();		
		integrationUserSysID = gr1.getValue('ucontrol_integration_user_sys_id') || '';
		integrationUserSysID2 = integrationUserSysID.toString();		
		midSrvNm = gr1.getValue('ucontrol_mid_server_name') || '';
		midSrvNm2 = midSrvNm.toString(); 		
		midSrvSysID = gr1.getValue('ucontrol_mid_server_sys_id') || '';
		midSrvSysID2 = midSrvSysID.toString(); 
		pollingInterval = gr1.getValue('ucontrol_polling_interval_minutes') || 0;
		url = gr1.getValue('ucontrol_url') || '';
		maxRetries = gr1.getValue('max_retries') || 0;
		jobStartedAt = gr1.getValue('sys_created_on');
		noOfLogRecords = gr1.getValue('number_of_processing_log_records') || 0;
	}
	
	var rtnSysID = '';
	var gr2 = new GlideRecordSecure(logTable); //x_tekso_twxapp01_processing_log
	gr2.initialize();
	gr2.setValue('total_number_of_records_sent',0);
	gr2.setValue('scheduled_job_started_at',jobStartedAt);	
	gr2.setValue('link_to_scheduled_job_log_record',jobSysID.toString());
	gr2.setValue('scheduled_job_log_record_sys_id',jobSysID.toString());

	gr2.setValue('process_no',processCnt);
	gr2.setValue('processing_id',pID); // Processing ID GUID. Set on CMDB records in the job
	gr2.setValue('number_of_updates_sent',0);
	gr2.setValue('number_of_deletes_sent',0);	
	gr2.setValue('data_sent_updates_per_class','');
	gr2.setValue('data_sent_deletes_per_class','');	
	gr2.setValue('ucontrol_url',url);
	gr2.setValue('ucontrol_mid_server_sys_id',midSrvSysID2);
	gr2.setValue('ucontrol_mid_server_name',midSrvNm);
	gr2.setValue('ucontrol_integration_user_sys_id',integrationUserSysID2);
	gr2.setValue('ucontrol_integration_user_name',integrationUserName2);
	gr2.setValue('max_retries',maxRetries);
	gr2.setValue('ucontrol_polling_interval_minutes',pollingInterval);
	gr2.setValue('ucontrol_connection_timeout_minutes',timeout);
	gr2.setValue('inserted_by_script','SA SendDataTouControl'); // Debug
	
	rtnSysID = gr2.insert();
	
	if (gotJobRecord == true) {
		var noOfLogRecords2 = parseInt(noOfLogRecords) + 1;
		gr1.setValue('number_of_processing_log_records',noOfLogRecords2);
		gr1.setValue('updated_by_script','SA SendDataTouControl'); // Debug		
		gr1.update();
	}
	
	return rtnSysID;
}


// Called by processBlock
function createLinkRecord(action,table,bsTbl,tstData,srcRecSysID,data_sys_id,trackingSysID,logSysID,jobSysID,pID) {
				
	var linkTable = 'x_tekso_twxapp01_cmdb_link_to_rest_data';
	var gr1 = new GlideRecordSecure(linkTable); //'x_tekso_twxapp01_cmdb_link_to_rest_data';
	gr1.initialize();
	gr1.setValue('action',action); // insert / delete
	gr1.setValue('table',table); // Blank for Delete
	gr1.setValue('base_table',bsTbl);
	gr1.setValue('test_data',tstData); // T/F
	gr1.setValue('source_record_sys_id',srcRecSysID); // Sys_id for the cmdb_ci / cmdb_rel_ci record to be processed
	gr1.setValue('link_to_rest_data_record',data_sys_id);
	gr1.setValue('link_to_processing_record',trackingSysID);
	gr1.setValue('link_to_processing_log_record',logSysID);
	gr1.setValue('rest_data_record_sys_id',data_sys_id);
	gr1.setValue('processing_record_sys_id',trackingSysID);
	gr1.setValue('processing_log_record_sys_id',logSysID);
	gr1.setValue('processing_id',pID); // Processing ID GUID
	gr1.setValue('link_to_scheduled_job_log_record',jobSysID);
	gr1.setValue('scheduled_job_log_record_sys_id',jobSysID);
	gr1.setValue('inserted_by_script','SA SendDataTouControl'); // Debug	
	gr1.insert();
}



// Called by processBlock
function createDataRecordWithEmptyJSON(brkRsn,action,bsTbl,tstData,midSrvNm,midSrvSysID,url,logSysID,jobSysID,pID) {
	var dataTable = 'x_tekso_twxapp01_rest_data_to_ucontrol';
	var gr1 = new GlideRecordSecure(dataTable); //x_tekso_twxapp01_rest_data_to_ucontrol
	gr1.initialize();
	gr1.setValue('action',action); // insert / delete
	gr1.setValue('base_table',bsTbl);
	gr1.setValue('test_data',tstData); // T/F
	gr1.setValue('ucontrol_mid_server_name',midSrvNm);
	gr1.setValue('ucontrol_mid_server_sys_id',midSrvSysID);		
	gr1.setValue('ucontrol_url',url);
	gr1.setValue('json_request_body','');
	gr1.setValue('json_request_body_first_1000_chars','');
	gr1.setValue('total_length_of_json_request_body',0);	
	gr1.setValue('no_of_cmdb_records_in_json_request_body',0);
	gr1.setValue('link_to_processing_log_record',logSysID);	
	gr1.setValue('processing_log_record_sys_id',logSysID);		
	gr1.setValue('processing_id',pID); // Processing ID GUID
	gr1.setValue('reason_for_split',brkRsn);
	gr1.setValue('link_to_scheduled_job_log_record',jobSysID);
	gr1.setValue('scheduled_job_log_record_sys_id',jobSysID);	
	gr1.setValue('inserted_by_script','SA SendDataTouControl'); // Debug
	var rtn_sys_id = gr1.insert();
	
	return rtn_sys_id;
}


// Called by processBlock
function addJSONToDataRecord(data_sys_id,jsonRequestBody,noOfRecsInJSON) {
	var dataTable = 'x_tekso_twxapp01_rest_data_to_ucontrol';
	var gr1 = new GlideRecordSecure(dataTable); //x_tekso_twxapp01_rest_data_to_ucontrol	
	gr1.addQuery('sys_id',data_sys_id);
	gr1.query();
	if (gr1.next()) {
		gr1.setValue('json_request_body',jsonRequestBody);
		if (jsonRequestBody.length > 1000) {
			gr1.setValue('json_request_body_first_1000_chars',jsonRequestBody.substring(0,1000));		
		}
		else {
			gr1.setValue('json_request_body_first_1000_chars',jsonRequestBody);			
		}
		gr1.setValue('total_length_of_json_request_body',jsonRequestBody.length);		
		gr1.setValue('no_of_cmdb_records_in_json_request_body',noOfRecsInJSON);
		gr1.setValue('updated_by_script','SA SendDataTouControl'); // Debug			
		gr1.update();
	}	
}

// Called by processBlock
function getDataRecordNo(data_sys_id) {
	var dataTable = 'x_tekso_twxapp01_rest_data_to_ucontrol';	
	var recordNo = '';
	var gr1 = new GlideRecordSecure(dataTable); //x_tekso_twxapp01_rest_data_to_ucontrol
	gr1.addQuery('sys_id',data_sys_id);
	gr1.query();
	if (gr1.next()) {
		recordNo = gr1.getValue('number') || '';
	}
	return recordNo;
}


function updateProcessingLogStats(logSysID) {

	var logTable = 'x_tekso_twxapp01_processing_log';
	var setupTable = 'x_tekso_twxapp01_setup';
	
	var noOfRecordsSent = numberOfRecordsLinkedToLog(logSysID);
	var noOfUpdatesSent = numberOfUpdatesLinkedToLog(logSysID);
	var noOfDeletesSent = numberOfDeletesLinkedToLog(logSysID);	
	var updatesPerClass = getUpdatesPerClassLinkedToLog(logSysID);
	var deletesPerClass = getDeletesPerClassLinkedToLog(logSysID);
	var dataSentSummary = sendSummary(noOfRecordsSent,noOfUpdatesSent,noOfDeletesSent);

	var noOfRestRecordsSent = numberOfRestRecordsLinkedToLog(logSysID); 
	var firstRestResponseSysID = firstRestResponseSysIDLinkedToLog(logSysID);
	var lastRestResponseSysID = lastRestResponseSysIDLinkedToLog(logSysID);

	var firstRestSysID = firstRestSysIDLinkedToLog(logSysID);
	var lastRestSysID = lastRestSysIDLinkedToLog(logSysID);
	var lastDT = lastDataDateLinkedToLog(logSysID);
	var restDataRecordContentSummary = restDataRecordContentsSummaryLinkedToLog(logSysID);
	
	//Totals	
	var gr1 = new GlideRecordSecure(logTable); //x_tekso_twxapp01_processing_log
	gr1.addQuery('sys_id',logSysID);
	gr1.query();
	if (gr1.next()) {

		gr1.setValue('total_number_of_records_sent',noOfRecordsSent);
		gr1.setValue('records_sent',true);
		gr1.setValue('number_of_updates_sent',noOfUpdatesSent);
		gr1.setValue('number_of_deletes_sent',noOfDeletesSent);

		gr1.setValue('data_sent_updates_per_class',updatesPerClass);
		gr1.setValue('data_sent_deletes_per_class',deletesPerClass);	
		gr1.setValue('data_sent_summary',dataSentSummary);
		
		var completedAt = GlideDateTime();
		gr1.setValue('rest_data_build_finished_at',completedAt);
			
		gr1.setValue('link_to_first_rest_response_record',firstRestResponseSysID);
		gr1.setValue('link_to_last_rest_response_record',lastRestResponseSysID);
		gr1.setValue('first_rest_response_record_sys_id',firstRestResponseSysID);
		gr1.setValue('last_rest_response_record_sys_id',lastRestResponseSysID);
		gr1.setValue('number_of_rest_resonse_records',noOfRecordsSent);		// Duplicate

		gr1.setValue('link_to_first_rest_data_record',firstRestSysID);
		gr1.setValue('link_to_last_rest_data_record',lastRestSysID);
		gr1.setValue('first_rest_data_record_sys_id',firstRestSysID);
		gr1.setValue('last_rest_data_record_sys_id',lastRestSysID);
		gr1.setValue('number_of_rest_data_records',noOfRestRecordsSent);		
		gr1.setValue('rest_data_record_contents_summary',restDataRecordContentSummary);
		gr1.setValue('updated_by_script','SA SendDataTouControl'); // Debug			
		gr1.update();	
		
		var gr2 = new GlideRecordSecure(setupTable); //x_tekso_twxapp01_setup
		gr2.query();
		if (gr2.next()) {
			gr2.setValue('link_to_last_processing_log_record',logSysID);		
			gr2.setValue('last_processing_data_sent_summary',dataSentSummary);
			gr2.setValue('last_processing_at',lastDT);			
			gr2.setValue('updated_by_script','SA SendDataTouControl'); // Debug		
			gr2.update();
		}
	}
}

// Called by updateProcessingLogStats() - which is called by mainBit()
// and by updateScheduledJobLogStats()
function sendSummary(recCnt,updCnt,delCnt) {
	// Builds a string like this: 3 records (3 updates , 0 deletes)
	var rtn = '';
	if (recCnt == 1) {
		rtn = '1 record';
	}
	else {
		rtn = recCnt.toString() + ' records';
	}	

	if (updCnt == 1) {
		rtn = rtn + ' (1 update';
	}
	else {
		rtn = rtn + ' (' + updCnt.toString() + ' updates';
	}

	if (delCnt == 1) {
		rtn = rtn + ' , 1 delete)';
	}
	else {
		rtn = rtn + ' , ' + delCnt.toString() + ' deletes)';
	}

	return rtn;
}


function numberOfRecordsLinkedToLog(logSysID) {
	var rtn = 0;
	var linkTable = 'x_tekso_twxapp01_cmdb_link_to_rest_data';
	var gr1 = new GlideAggregate(linkTable); //'x_tekso_twxapp01_cmdb_link_to_rest_data'
	gr1.addQuery('link_to_processing_log_record',logSysID);
	gr1.addAggregate('COUNT');
	gr1.query();
	gr1.next(); // GlideAggregate needs the .next()	
	rtn = gr1.getAggregate('COUNT');
	return rtn;
}

function numberOfRestRecordsLinkedToLog(logSysID) {
	var rtn = 0;
	var dataTable = 'x_tekso_twxapp01_rest_data_to_ucontrol';
	var gr1 = new GlideAggregate(dataTable); //'x_tekso_twxapp01_rest_data_to_ucontrol'
	gr1.addQuery('link_to_processing_log_record',logSysID);	
	gr1.addAggregate('COUNT');
	gr1.query();
	gr1.next(); // GlideAggregate needs the .next()		
	rtn = gr1.getAggregate('COUNT');
	return rtn;	
}

		
function numberOfUpdatesLinkedToLog(logSysID) {
	var rtn = 0;
	var linkTable = 'x_tekso_twxapp01_cmdb_link_to_rest_data';
	var gr1 = new GlideAggregate(linkTable); //'x_tekso_twxapp01_cmdb_link_to_rest_data'
	gr1.addQuery('link_to_processing_log_record',logSysID);
	gr1.addQuery('action','update');
	gr1.addAggregate('COUNT');
	gr1.query();
	gr1.next(); // GlideAggregate needs the .next()		
	rtn = gr1.getAggregate('COUNT');
	return rtn;
}

function numberOfDeletesLinkedToLog(logSysID) {
	var rtn = 0;
	var linkTable = 'x_tekso_twxapp01_cmdb_link_to_rest_data';
	var gr1 = new GlideAggregate(linkTable); //'x_tekso_twxapp01_cmdb_link_to_rest_data'
	gr1.addQuery('link_to_processing_log_record',logSysID);
	gr1.addQuery('action','delete');
	gr1.addAggregate('COUNT');
	gr1.query();
	gr1.next(); // GlideAggregate needs the .next()		
	rtn = gr1.getAggregate('COUNT');
	return rtn;
}


function numberOfRecordsLinkedToJob(jobSysID) {
	var rtn = 0;
	var linkTable = 'x_tekso_twxapp01_cmdb_link_to_rest_data';
	var gr1 = new GlideAggregate(linkTable); //'x_tekso_twxapp01_cmdb_link_to_rest_data'
	gr1.addQuery('link_to_scheduled_job_log_record',jobSysID);
	gr1.addAggregate('COUNT');
	gr1.query();
	gr1.next(); // GlideAggregate needs the .next()		
	rtn = gr1.getAggregate('COUNT');
	return rtn;
}

function numberOfUpdatesLinkedToJob(jobSysID) {
	var rtn = 0;
	var linkTable = 'x_tekso_twxapp01_cmdb_link_to_rest_data';
	var gr1 = new GlideAggregate(linkTable); //'x_tekso_twxapp01_cmdb_link_to_rest_data'
	gr1.addQuery('link_to_scheduled_job_log_record',jobSysID);
	gr1.addQuery('action','update');
	gr1.addAggregate('COUNT');
	gr1.query();
	gr1.next(); // GlideAggregate needs the .next()		
	rtn = gr1.getAggregate('COUNT');
	return rtn;
}

function numberOfDeletesLinkedToJob(jobSysID) {
	var rtn = 0;
	var linkTable = 'x_tekso_twxapp01_cmdb_link_to_rest_data';
	var gr1 = new GlideAggregate(linkTable); //'x_tekso_twxapp01_cmdb_link_to_rest_data'
	gr1.addQuery('link_to_scheduled_job_log_record',jobSysID);
	gr1.addQuery('action','delete');
	gr1.addAggregate('COUNT');
	gr1.query();
	gr1.next(); // GlideAggregate needs the .next()		
	rtn = gr1.getAggregate('COUNT');
	return rtn;
}


function getUpdatesPerClassLinkedToLog(logSysID) {
	var linkTable = 'x_tekso_twxapp01_cmdb_link_to_rest_data';
	
	var sentUpdPerClsArr2 = [];	
	var sentUpdPerClsArr = [];
	var sentUpdPerCls = '';
	var cnt = 0;

	var gr1 = new GlideRecordSecure(linkTable); //'x_tekso_twxapp01_cmdb_link_to_rest_data'	
	gr1.addQuery('link_to_processing_log_record',logSysID);
	gr1.addQuery('action','update');	
	gr1.query();	
	while(gr1.next()) {		
		var table = gr1.getValue('table') || '';
		var idx = sentUpdPerClsArr.indexOf(table);
		cnt = cnt + 1;
		if (idx < 0) {
			// The table  \ class is not already in the array - so add it
			sentUpdPerClsArr.push(table);
			sentUpdPerClsArr2.push(1);
		}
		else {
			// Increment the count for this table \ class				
			sentUpdPerClsArr2[idx] = sentUpdPerClsArr2[idx] + 1;
		}			
	} //while(gr1.next()) {
	
	if (cnt > 0) {
		for (var i = 0; i < sentUpdPerClsArr.length; i++) {
			var sentUpdPerClsCnt = sentUpdPerClsArr2[i].toString();
			if (i == 0) {
				// 1st Record
				sentUpdPerCls = sentUpdPerClsArr[i] + ': ' + sentUpdPerClsCnt;
			}
			else {
				sentUpdPerCls = sentUpdPerCls + ', ' + sentUpdPerClsArr[i] + ': ' + sentUpdPerClsCnt;
			}
		}
	}
	return sentUpdPerCls;
}


function getDeletesPerClassLinkedToLog(logSysID) {
	var linkTable = 'x_tekso_twxapp01_cmdb_link_to_rest_data';
	
	var sentDelPerClsArr2 = [];	
	var sentDelPerClsArr = [];
	var sentDelPerCls = '';
	var cnt = 0;

	var gr1 = new GlideRecordSecure(linkTable); //'x_tekso_twxapp01_cmdb_link_to_rest_data'	
	gr1.addQuery('link_to_processing_log_record',logSysID);
	gr1.addQuery('action','delete');	
	gr1.query();	
	while(gr1.next()) {		
		var table = gr1.getValue('table') || '';
		var idx = sentDelPerClsArr.indexOf(table);
		cnt = cnt + 1;
		if (idx < 0) {
			// The table  \ class is not already in the array - so add it
			sentDelPerClsArr.push(table);
			sentDelPerClsArr2.push(1);
		}
		else {
			// Increment the count for this table \ class				
			sentDelPerClsArr2[idx] = sentDelPerClsArr2[idx] + 1;
		}			
	} //while(gr1.next()) {
	
	if (cnt > 0) {
		for (var i = 0; i < sentDelPerClsArr.length; i++) {
			var sentDelPerClsCnt = sentDelPerClsArr2[i].toString();
			if (i == 0) {
				// 1st Record
				sentDelPerCls = sentDelPerClsArr[i] + ': ' + sentDelPerClsCnt;
			}
			else {
				sentDelPerCls = sentDelPerCls + ', ' + sentDelPerClsArr[i] + ': ' + sentDelPerClsCnt;
			}
		}
	}
	return sentDelPerCls;
}



function getUpdatesPerClassLinkedToJob(jobSysID) {
	var linkTable = 'x_tekso_twxapp01_cmdb_link_to_rest_data';
	
	var sentUpdPerClsArr2 = [];	
	var sentUpdPerClsArr = [];
	var sentUpdPerCls = '';
	var cnt = 0;

	var gr1 = new GlideRecordSecure(linkTable); //'x_tekso_twxapp01_cmdb_link_to_rest_data'	
	gr1.addQuery('link_to_scheduled_job_log_record',jobSysID);
	gr1.addQuery('action','update');	
	gr1.query();	
	while(gr1.next()) {		
		var table = gr1.getValue('table') || '';
		var idx = sentUpdPerClsArr.indexOf(table);
		cnt = cnt + 1;
		if (idx < 0) {
			// The table  \ class is not already in the array - so add it
			sentUpdPerClsArr.push(table);
			sentUpdPerClsArr2.push(1);
		}
		else {
			// Increment the count for this table \ class				
			sentUpdPerClsArr2[idx] = sentUpdPerClsArr2[idx] + 1;
		}			
	} //while(gr1.next()) {
	
	if (cnt > 0) {
		for (var i = 0; i < sentUpdPerClsArr.length; i++) {
			var sentUpdPerClsCnt = sentUpdPerClsArr2[i].toString();
			if (i == 0) {
				// 1st Record
				sentUpdPerCls = sentUpdPerClsArr[i] + ': ' + sentUpdPerClsCnt;
			}
			else {
				sentUpdPerCls = sentUpdPerCls + ', ' + sentUpdPerClsArr[i] + ': ' + sentUpdPerClsCnt;
			}
		}
	}
	return sentUpdPerCls;
}



function getDeletesPerClassLinkedToJob(jobSysID) {
	var linkTable = 'x_tekso_twxapp01_cmdb_link_to_rest_data';
	
	var sentDelPerClsArr2 = [];	
	var sentDelPerClsArr = [];
	var sentDelPerCls = '';
	var cnt = 0;

	var gr1 = new GlideRecordSecure(linkTable); //'x_tekso_twxapp01_cmdb_link_to_rest_data'	
	gr1.addQuery('link_to_scheduled_job_log_record',jobSysID);
	gr1.addQuery('action','delete');	
	gr1.query();	
	while(gr1.next()) {		
		var table = gr1.getValue('table') || '';
		var idx = sentDelPerClsArr.indexOf(table);
		cnt = cnt + 1;
		if (idx < 0) {
			// The table  \ class is not already in the array - so add it
			sentDelPerClsArr.push(table);
			sentDelPerClsArr2.push(1);
		}
		else {
			// Increment the count for this table \ class				
			sentDelPerClsArr2[idx] = sentDelPerClsArr2[idx] + 1;
		}			
	} //while(gr1.next()) {
	
	if (cnt > 0) {
		for (var i = 0; i < sentDelPerClsArr.length; i++) {
			var sentDelPerClsCnt = sentDelPerClsArr2[i].toString();
			if (i == 0) {
				// 1st Record
				sentDelPerCls = sentDelPerClsArr[i] + ': ' + sentDelPerClsCnt;
			}
			else {
				sentDelPerCls = sentDelPerCls + ', ' + sentDelPerClsArr[i] + ': ' + sentDelPerClsCnt;
			}
		}
	}
	return sentDelPerCls;
}

	
function firstRestResponseSysIDLinkedToLog(logSysID) {

	var linkTable = 'x_tekso_twxapp01_cmdb_link_to_rest_data';	
	var firstRestResponseSysID = '';
	var gr1 = new GlideRecordSecure(linkTable); //'x_tekso_twxapp01_cmdb_link_to_rest_data'	
	gr1.addQuery('link_to_processing_log_record',logSysID);
	gr1.orderBy('sys_created_on');
	gr1.setLimit(1);
	gr1.query();	
	if (gr1.next()) {
		var linkSysID = gr1.getValue('sys_id');
		firstRestResponseSysID = linkSysID.toString();
	}
	return firstRestResponseSysID;
}

function lastRestResponseSysIDLinkedToLog(logSysID) {

	var linkTable = 'x_tekso_twxapp01_cmdb_link_to_rest_data';	
	var lastRestResponseSysID = '';
	var gr1 = new GlideRecordSecure(linkTable); //'x_tekso_twxapp01_cmdb_link_to_rest_data'	
	gr1.addQuery('link_to_processing_log_record',logSysID);
	gr1.orderBy('number');
	gr1.orderBy('sys_created_on');
	gr1.query();	
	while (gr1.next()) {
		var linkSysID = gr1.getValue('sys_id');
		lastRestResponseSysID = linkSysID.toString();
	}
	return lastRestResponseSysID;
}


function firstRestSysIDLinkedToLog(logSysID) {

	var dataTable = 'x_tekso_twxapp01_rest_data_to_ucontrol';
	var firstRestSysID = '';
	var gr1 = new GlideRecordSecure(dataTable); //x_tekso_twxapp01_rest_data_to_ucontrol
	gr1.addQuery('link_to_processing_log_record',logSysID);
	gr1.orderBy('sys_created_on');
	gr1.setLimit(1);
	gr1.query();	
	if (gr1.next()) {
		var linkSysID = gr1.getValue('sys_id');
		firstRestSysID = linkSysID.toString();
	}
	return firstRestSysID;
}


function lastRestSysIDLinkedToLog(logSysID) {

	var dataTable = 'x_tekso_twxapp01_rest_data_to_ucontrol';
	var lastRestSysID = '';
	var gr1 = new GlideRecordSecure(dataTable); //x_tekso_twxapp01_rest_data_to_ucontrol
	gr1.addQuery('link_to_processing_log_record',logSysID);	
	gr1.orderBy('number');
	gr1.orderBy('sys_created_on');
	gr1.query();	
	while (gr1.next()) {
		var linkSysID = gr1.getValue('sys_id');
		lastRestSysID = linkSysID.toString();
	}
	return lastRestSysID;
}

/*
function firstRestResponseSysIDLinkedToJob(jobSysID) {

	var linkTable = 'x_tekso_twxapp01_cmdb_link_to_rest_data';	
	var firstRestResponseSysID = '';
	var gr1 = new GlideRecord(linkTable); //'x_tekso_twxapp01_cmdb_link_to_rest_data'	
	gr1.addQuery('link_to_scheduled_job_log_record',jobSysID);
	gr1.orderBy('sys_created_on');
	gr1.setLimit(1);
	gr1.query();	
	if (gr1.next()) {
		var linkSysID = gr1.getValue('sys_id');
		firstRestResponseSysID = linkSysID.toString();
	}
	return firstRestResponseSysID;
}
*/

/*
function lastRestResponseSysIDLinkedToJob(jobSysID) {

	var linkTable = 'x_tekso_twxapp01_cmdb_link_to_rest_data';	
	var lastRestResponseSysID = '';
	var gr1 = new GlideRecord(linkTable); //'x_tekso_twxapp01_cmdb_link_to_rest_data'	
	gr1.addQuery('link_to_scheduled_job_log_record',jobSysID);
	gr1.orderBy('number');
	gr1.orderBy('sys_created_on');
	gr1.query();	
	while (gr1.next()) {
		var linkSysID = gr1.getValue('sys_id');
		lastRestResponseSysID = linkSysID.toString();
	}
	return lastRestResponseSysID;
}
*/

/*	
function firstRestSysIDLinkedToJob(jobSysID) {

	var dataTable = 'x_tekso_twxapp01_rest_data_to_ucontrol';
	var firstRestSysID = '';
	var gr1 = new GlideRecord(dataTable); //x_tekso_twxapp01_rest_data_to_ucontrol
	gr1.addQuery('link_to_scheduled_job_log_record',jobSysID);
	gr1.orderBy('sys_created_on');
	gr1.setLimit(1);
	gr1.query();	
	if (gr1.next()) {
		var linkSysID = gr1.getValue('sys_id');
		firstRestSysID = linkSysID.toString();
	}
	return firstRestSysID;
}
*/

/*
function lastRestSysIDLinkedToJob(jobSysID) {

	var dataTable = 'x_tekso_twxapp01_rest_data_to_ucontrol';
	var lastRestSysID = '';
	var gr1 = new GlideRecord(dataTable); //x_tekso_twxapp01_rest_data_to_ucontrol	
	gr1.addQuery('link_to_scheduled_job_log_record',jobSysID);
	gr1.orderBy('number');
	gr1.orderBy('sys_created_on');
	gr1.query();	
	while (gr1.next()) {
		var linkSysID = gr1.getValue('sys_id');
		lastRestSysID = linkSysID.toString();
	}
	return lastRestSysID;
}
*/

function lastDataDateLinkedToLog(logSysID) {

	var dt = new GlideDateTime();
	var dataTable = 'x_tekso_twxapp01_rest_data_to_ucontrol';
	var gr1 = new GlideRecordSecure(dataTable); //x_tekso_twxapp01_rest_data_to_ucontrol	
	gr1.addQuery('link_to_processing_log_record',logSysID);
	gr1.orderBy('number');
	gr1.orderBy('sys_created_on');
	gr1.query();	
	while (gr1.next()) {
		dt = gr1.getValue('sys_created_on');
	}
	return dt;
}

/*
function lastDataDateLinkedToJob(jobSysID) {

	var dt = new GlideDateTime();
	var dataTable = 'x_tekso_twxapp01_rest_data_to_ucontrol';
	var gr1 = new GlideRecord(dataTable); //x_tekso_twxapp01_rest_data_to_ucontrol	
	gr1.addQuery('link_to_scheduled_job_log_record',jobSysID);
	gr1.orderBy('number');
	gr1.orderBy('sys_created_on');
	gr1.query();	
	while (gr1.next()) {
		dt = gr1.getValue('sys_created_on');
	}
	return dt;
}
*/

function restDataRecordContentsSummaryLinkedToLog(logSysID) {

	var summary = '';
	var dataTable = 'x_tekso_twxapp01_rest_data_to_ucontrol';
	var gr1 = new GlideRecordSecure(dataTable); //x_tekso_twxapp01_rest_data_to_ucontrol
	gr1.addQuery('link_to_processing_log_record',logSysID);	
	gr1.orderBy('number');
	gr1.orderBy('sys_created_on');
	gr1.query();	
	var cnt = 0;
	while (gr1.next()) {
		var number = gr1.getValue('number') || '';
		var action = gr1.getValue('action') || '';
		var bsTbl = gr1.getValue('base_table') || '';
		var qty = gr1.getValue('no_of_cmdb_records_in_json_request_body') || 0;
		var qty2 = qty.toString();
		var record = number + ' Action: ' + action + ', Base Table: ' + bsTbl + ', Qty: ' + qty2;
		if (cnt == 0) {
			summary = record;
		}
		else {
			summary = summary + '; ' + record;
		}
		cnt = cnt + 1;
	}
	return summary;
}	



/* Not used - would be used for INSERT
// Called by processBlock
function createDataRecordWithJSON(dataTable,action,bsTbl,tstData,midSrvNm,midSrvSysID,url,JSONRequestBody,noOfRecsInJSON,logSysID) {
	var gr1 = new GlideRecord(dataTable); //x_tekso_twxapp01_rest_data_to_ucontrol
	gr1.initialize();
	gr1.setValue('action',action); // insert
	gr1.setValue('base_table',bsTbl);
	gr1.setValue('test_data',tstData); // T/F
	gr1.setValue('ucontrol_mid_server_name',midSrvNm);
	gr1.setValue('ucontrol_mid_server_sys_id',midSrvSysID);		
	gr1.setValue('ucontrol_url',url);						
	gr1.setValue('json_request_body',JSONRequestBody);
	if (jsonRequestBody.length > 1000) {
		gr1.setValue('json_request_body_first_1000_chars',jsonRequestBody.substring(0,1000));		
	}
	else {
		gr1.setValue('json_request_body_first_1000_chars',jsonRequestBody);			
	}	
	gr1.setValue('total_length_of_json_request_body',JSONRequestBody.length);
	gr1.setValue('no_of_cmdb_records_in_json_request_body',noOfRecsInJSON);
	gr1.setValue('link_to_processing_log_record',logSysID);
	gr1.setValue('processing_log_record_sys_id',logSysID);	
	gr1.setValue('inserted_by_script','SA SendDataTouControl'); // Debug	
	var rtn_sys_id = gr1.insert();
	
	return rtn_sys_id;
}
*/]]></script>
        <synchronous>false</synchronous>
        <sys_class_name>sysevent_script_action</sys_class_name>
        <sys_created_by>robin</sys_created_by>
        <sys_created_on>2020-05-20 15:31:37</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>86d43b8fdbb0d05041d08f381396190b</sys_id>
        <sys_mod_count>77</sys_mod_count>
        <sys_name>SendDataTouControl</sys_name>
        <sys_overrides/>
        <sys_package display_value="Application 1" source="x_tekso_twxapp01">993be4b2db62085035a38a72399619a7</sys_package>
        <sys_policy/>
        <sys_scope display_value="Application 1">993be4b2db62085035a38a72399619a7</sys_scope>
        <sys_update_name>sysevent_script_action_86d43b8fdbb0d05041d08f381396190b</sys_update_name>
        <sys_updated_by>robin</sys_updated_by>
        <sys_updated_on>2020-06-24 14:03:45</sys_updated_on>
    </sysevent_script_action>
</record_update>
